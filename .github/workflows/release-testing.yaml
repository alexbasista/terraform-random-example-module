# .github/workflows/release-testing.yaml
name: Terraform Module Release Testing

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'VERSION'

permissions:
  contents: read
  pull-requests: write

env:
  LOCAL_TF_VERSION: "1.13.2"

jobs:
# -------------------------------------
# Job: Run basic CI test first
# -------------------------------------
  ci-checks-NAMETEST:
    #name: "Terraform Module CI Checks"
    uses: ./.github/workflows/ci.yaml
    secrets: inherit

# -----------------------------------------------------------------------------
# Job: Discover SemVer tags for upgrade compatibility test
# -----------------------------------------------------------------------------
  discover-semver-tags:
    name: "Discover SemVer Tags"
    needs: ci-checks-NAMETEST
    runs-on: ubuntu-latest
    env:
      INCLUDE_PREVIOUS_MAJOR_VERSION: true # set to false to skip N-1 major version test
    outputs:
      has_tags: ${{ steps.get-tags.outputs.has_tags }}
      tags: ${{ steps.get-tags.outputs.tags }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest SemVer tags
        id: get-tags
        shell: bash
        run: |
          set -e
          git fetch --tags
          tags=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' | grep -Ev -- '-' || true)
          if [ -z "$tags" ]; then
            echo "No semantic version tags found. Skipping upgrade test."
            echo "tags<<EOF" >> $GITHUB_OUTPUT
            echo "[]" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_tags=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          sorted_tags=$(echo "$tags" | sort -V)
          major_versions=$(echo "$sorted_tags" | sed -E 's/^v([0-9]+)\..*/\1/' | sort -nr | uniq)
          current_major=$(echo "$major_versions" | head -n1 || true)
          prev_major=$(echo "$major_versions" | sed -n 2p || true)
          latest_tag=""
          prev_major_tag=""
          if [ -n "$current_major" ]; then
            latest_tag=$(echo "$sorted_tags" | grep "^v${current_major}\." | tail -n1 || true)
          fi
          if [ -n "$prev_major" ]; then
            prev_major_tag=$(echo "$sorted_tags" | grep "^v${prev_major}\." | tail -n1 || true)
          fi
          arr=()
          [ -n "$latest_tag" ] && arr+=("$latest_tag")
          if [[ "${INCLUDE_PREVIOUS_MAJOR_VERSION}" == "true" ]]; then
            [ -n "$prev_major_tag" ] && arr+=("$prev_major_tag")
          fi
          arr_json=$(printf '%s\n' "${arr[@]}" | jq -R . | jq -s -c .)
          echo "has_tags=true" >> $GITHUB_OUTPUT
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "${arr_json}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Discovered tags: ${arr_json}"

# -----------------------------------------------------------------------------
# Job: Upgrade compatibility test from existing module versions
# -----------------------------------------------------------------------------
  upgrade-test:
    name: "Upgrade Compatibility Test (from: ${{ matrix.upgrade_from_version }})"
    needs: discover-semver-tags
    if: needs.discover-semver-tags.outputs.has_tags == 'true'
    runs-on: ubuntu-latest
    env:
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_TOKEN_APP_TERRAFORM_IO }}
      TEST_DIR: tests/integration
    strategy:
      fail-fast: false
      matrix:
        upgrade_from_version: ${{ fromJson(needs.discover-semver-tags.outputs.tags) }}
      max-parallel: 1  # Sequential execution since matrix jobs target the same TFC workspace
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Terraform ${{ env.LOCAL_TF_VERSION }}
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.LOCAL_TF_VERSION }}

      - name: Print test details
        run: |
          echo "==============================================="
          echo "ðŸš€ TERRAFORM MODULE UPGRADE COMPATIBILITY TEST"
          echo "==============================================="
          echo "ðŸ“¦ Upgrade from: ${{ matrix.upgrade_from_version }}"
          echo "ðŸ“ Test directory: ${{ env.TEST_DIR }}"
          echo "ðŸ”§ Terraform version: ${{ env.LOCAL_TF_VERSION }} (ensure your remote workspace is configured to match)"
          echo "==============================================="
      
      # - name: Checkout baseline module version (upgrade_from)
      #   run: |
      #     BASELINE_DIR="baseline-${{ matrix.upgrade_from_version }}"
      #     git clone . "$BASELINE_DIR"
      #     cd "$BASELINE_DIR"
      #     git checkout "${{ matrix.upgrade_from_version }}"
      #     ls -l

      - name: Checkout baseline at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.upgrade_from_version }}
          path: baseline-${{ matrix.upgrade_from_version }}
          fetch-depth: 1

      # - name: Update module source to baseline version
      #   run: |
      #     BASELINE_DIR="baseline-${{ matrix.upgrade_from_version }}"
      #     sed -i 's|source = .*|source = "git::https://github.com/${{ github.repository }}.git//.?ref=${{ matrix.upgrade_from_version }}"|' "$BASELINE_DIR/tests/${{ env.TEST_DIR }}/main.tf"

      - name: Terraform apply baseline version
        run: |
          BASELINE_DIR="baseline-${{ matrix.upgrade_from_version }}"
          #cat "$BASELINE_DIR/${{ env.TEST_DIR }}/main.tf"
          terraform -chdir="$BASELINE_DIR/${{ env.TEST_DIR }}" init -input=false
          terraform -chdir="$BASELINE_DIR/${{ env.TEST_DIR }}" apply -auto-approve

      # - name: Switch to local module source (current branch)
      #   run: |
      #     sed -i 's|source = .*|source = "../.."|' tests/${{ env.TEST_DIR }}/main.tf

      - name: Terraform plan target version
        id: plan_target_version
        run: |
          terraform -chdir=${{ env.TEST_DIR }} init -upgrade -input=false
          terraform -chdir=${{ env.TEST_DIR }} plan -input=false -out=tfplan || exit_code=$?
          echo "exit_code=${exit_code:-0}" >> "$GITHUB_OUTPUT"

      - name: Save Terraform plan output
        id: save_plan_output
        run: |
          set -uo pipefail
          
          terraform -chdir=${{ env.TEST_DIR }} show -no-color tfplan > plan.txt
          terraform -chdir=${{ env.TEST_DIR }} show -json tfplan > plan.json

          resource_changes=$(jq -r '[.resource_changes[]? | select(.change.actions != ["no-op"])] | length' plan.json)
          #output_changes=$(jq -r '.output_changes // {} | length' plan.json)
          output_changes=0

          total_changes=$((resource_changes + output_changes))

          if [ "$total_changes" -gt 0 ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Plan has $resource_changes resource changes and $output_changes output changes - will apply"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "Plan has no changes - will skip apply"
          fi

      - name: Comment plan output on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### Terraform Plan Output (Upgrade Test from \`${{ matrix.upgrade_from_version }}\`)\n\`\`\`\n${plan}\n\`\`\``
            });

      - name: Terraform apply target version
        if: steps.save_plan_output.outputs.has_changes == 'true'
        run: |
          echo "Exit code from plan step: '${{ steps.plan_target_version.outputs.exit_code }}'"
          terraform -chdir=${{ env.TEST_DIR }} apply -input=false tfplan

      - name: Terraform destroy (cleanup)
        if: always()
        run: |
          terraform -chdir=${{ env.TEST_DIR }} destroy -auto-approve